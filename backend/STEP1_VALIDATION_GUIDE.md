# 🔧 Step 1 Validation Implementation Guide

## 📋 **Overview**

This guide shows how to implement Step 1 validation that checks for duplicate credentials when users click "Next Face Registration" button. All duplicate alerts will be shown at Step 1 before proceeding to face registration.

## 🎯 **Enhanced Duplicate Checks**

Now includes **6 duplicate validations**:

1. **Username Duplicate** - "Username already taken."
2. **Email Duplicate** - "Email is already taken."
3. **Mobile Number Duplicate** - "Mobile number is already registered."
4. **Password Duplicate** - "Password is already taken."
5. **Roll Number Duplicate** - "Roll number already exists"
6. **Face Duplicate** - "This face is already registered with another account." (Step 2)

## 🔗 **New API Endpoints**

### **Step 1 Validation Endpoint**
```javascript
POST /api/students/validate-step1/
Body: {
    "username": "john_doe",
    "email": "john@example.com",
    "password": "mypassword123",
    "phone_number": "1234567890",
    "roll_number": "22"
}

// Success Response (200)
{
    "message": "Step 1 validation successful. You can proceed to face registration.",
    "valid": true
}

// Error Response (400)
{
    "username": ["Username already taken."],
    "email": ["Email is already taken."],
    "password": ["Password is already taken."],
    "phone_number": ["Mobile number is already registered."],
    "roll_number": ["Roll number already exists"]
}
```

### **Individual Username Check**
```javascript
GET /api/students/check-username-duplicate/?username=john_doe

Response:
{
    "exists": true/false,
    "message": "Username already taken." or "Username is available."
}
```

## 🎨 **Frontend Implementation**

### **React Implementation with Step 1 Validation**

```jsx
import React, { useState, useEffect } from 'react';
import axios from 'axios';

const TwoStepRegistrationForm = () => {
    const [currentStep, setCurrentStep] = useState(1);
    const [formData, setFormData] = useState({
        // Step 1 fields
        username: '',
        email: '',
        password: '',
        confirm_password: '',
        first_name: '',
        last_name: '',
        roll_number: '',
        student_class: '',
        phone_number: '',
        address: '',
        // Step 2 field
        face_image_data: ''
    });
    
    const [errors, setErrors] = useState({});
    const [duplicateWarnings, setDuplicateWarnings] = useState({});
    const [isValidating, setIsValidating] = useState(false);
    
    // Real-time duplicate checking (debounced)
    const checkDuplicate = async (field, value) => {\n        if (!value) return;\n        \n        try {\n            let response;\n            \n            switch (field) {\n                case 'username':\n                    response = await axios.get(`/api/students/check-username-duplicate/?username=${value}`);\n                    break;\n                case 'email':\n                    response = await axios.get(`/api/students/check-email-duplicate/?email=${value}`);\n                    break;\n                case 'phone_number':\n                    response = await axios.get(`/api/students/check-phone-duplicate/?phone_number=${value}`);\n                    break;\n                case 'password':\n                    response = await axios.post('/api/students/check-password-duplicate/', { password: value });\n                    break;\n                case 'roll_number':\n                    response = await axios.get(`/api/students/check-roll-number-duplicate/?roll_number=${value}`);\n                    break;\n                default:\n                    return;\n            }\n            \n            if (response.data.exists) {\n                setDuplicateWarnings(prev => ({\n                    ...prev,\n                    [field]: response.data.message\n                }));\n            } else {\n                setDuplicateWarnings(prev => {\n                    const newWarnings = { ...prev };\n                    delete newWarnings[field];\n                    return newWarnings;\n                });\n            }\n            \n        } catch (error) {\n            console.error(`Error checking ${field} duplicate:`, error);\n        }\n    };\n    \n    // Debounced duplicate checking\n    useEffect(() => {\n        const timer = setTimeout(() => {\n            if (formData.username) checkDuplicate('username', formData.username);\n        }, 500);\n        return () => clearTimeout(timer);\n    }, [formData.username]);\n    \n    useEffect(() => {\n        const timer = setTimeout(() => {\n            if (formData.email) checkDuplicate('email', formData.email);\n        }, 500);\n        return () => clearTimeout(timer);\n    }, [formData.email]);\n    \n    useEffect(() => {\n        const timer = setTimeout(() => {\n            if (formData.phone_number) checkDuplicate('phone_number', formData.phone_number);\n        }, 500);\n        return () => clearTimeout(timer);\n    }, [formData.phone_number]);\n    \n    useEffect(() => {\n        const timer = setTimeout(() => {\n            if (formData.password) checkDuplicate('password', formData.password);\n        }, 500);\n        return () => clearTimeout(timer);\n    }, [formData.password]);\n    \n    useEffect(() => {\n        const timer = setTimeout(() => {\n            if (formData.roll_number) checkDuplicate('roll_number', formData.roll_number);\n        }, 500);\n        return () => clearTimeout(timer);\n    }, [formData.roll_number]);\n    \n    const handleInputChange = (e) => {\n        const { name, value } = e.target;\n        setFormData(prev => ({\n            ...prev,\n            [name]: value\n        }));\n        \n        // Clear errors when user starts typing\n        if (errors[name]) {\n            setErrors(prev => {\n                const newErrors = { ...prev };\n                delete newErrors[name];\n                return newErrors;\n            });\n        }\n    };\n    \n    // Step 1: Validate credentials before proceeding to face registration\n    const validateStep1 = async () => {\n        setIsValidating(true);\n        setErrors({});\n        \n        try {\n            const step1Data = {\n                username: formData.username,\n                email: formData.email,\n                password: formData.password,\n                phone_number: formData.phone_number,\n                roll_number: formData.roll_number\n            };\n            \n            const response = await axios.post('/api/students/validate-step1/', step1Data);\n            \n            if (response.status === 200) {\n                // Validation successful, proceed to Step 2\n                setCurrentStep(2);\n                alert('Step 1 validation successful! Please proceed with face registration.');\n            }\n            \n        } catch (error) {\n            if (error.response?.status === 400) {\n                const validationErrors = error.response.data;\n                setErrors(validationErrors);\n                \n                // Show specific alerts for each duplicate error\n                const alertMessages = {\n                    username: 'Username already taken.',\n                    email: 'Email is already taken.',\n                    password: 'Password is already taken.',\n                    phone_number: 'Mobile number is already registered.',\n                    roll_number: 'Roll number already exists'\n                };\n                \n                // Show alerts for each error\n                Object.keys(validationErrors).forEach(field => {\n                    if (alertMessages[field]) {\n                        alert(alertMessages[field]);\n                    }\n                });\n                \n                // Show summary alert\n                const errorCount = Object.keys(validationErrors).length;\n                alert(`Found ${errorCount} duplicate credential(s). Please fix the issues and try again.`);\n            } else {\n                alert('Validation failed. Please try again.');\n            }\n        } finally {\n            setIsValidating(false);\n        }\n    };\n    \n    // Step 2: Complete registration with face\n    const completeRegistration = async () => {\n        try {\n            const response = await axios.post('/api/students/enhanced-register/', formData);\n            alert('Registration completed successfully!');\n            // Handle success (redirect, etc.)\n        } catch (error) {\n            if (error.response?.data) {\n                const errorData = error.response.data;\n                \n                // Handle face duplicate error\n                if (errorData.face_image_data) {\n                    alert('This face is already registered with another account.');\n                }\n                \n                // Handle other errors\n                Object.keys(errorData).forEach(field => {\n                    if (errorData[field] && Array.isArray(errorData[field])) {\n                        alert(errorData[field][0]);\n                    }\n                });\n            } else {\n                alert('Registration failed. Please try again.');\n            }\n        }\n    };\n    \n    const handleFaceCapture = (imageData) => {\n        setFormData(prev => ({\n            ...prev,\n            face_image_data: imageData\n        }));\n    };\n    \n    return (\n        <div className=\"registration-container\">\n            <div className=\"step-indicator\">\n                <div className={`step ${currentStep >= 1 ? 'active' : ''}`}>1. Credentials</div>\n                <div className={`step ${currentStep >= 2 ? 'active' : ''}`}>2. Face Registration</div>\n            </div>\n            \n            {currentStep === 1 && (\n                <div className=\"step1-form\">\n                    <h2>Step 1: Enter Your Credentials</h2>\n                    \n                    {/* Username Field */}\n                    <div className=\"form-group\">\n                        <label>Username:</label>\n                        <input\n                            type=\"text\"\n                            name=\"username\"\n                            value={formData.username}\n                            onChange={handleInputChange}\n                            className={errors.username || duplicateWarnings.username ? 'error' : ''}\n                            required\n                        />\n                        {errors.username && (\n                            <span className=\"error-message\">{errors.username[0]}</span>\n                        )}\n                        {duplicateWarnings.username && (\n                            <span className=\"warning-message\">{duplicateWarnings.username}</span>\n                        )}\n                    </div>\n                    \n                    {/* Email Field */}\n                    <div className=\"form-group\">\n                        <label>Email:</label>\n                        <input\n                            type=\"email\"\n                            name=\"email\"\n                            value={formData.email}\n                            onChange={handleInputChange}\n                            className={errors.email || duplicateWarnings.email ? 'error' : ''}\n                            required\n                        />\n                        {errors.email && (\n                            <span className=\"error-message\">{errors.email[0]}</span>\n                        )}\n                        {duplicateWarnings.email && (\n                            <span className=\"warning-message\">{duplicateWarnings.email}</span>\n                        )}\n                    </div>\n                    \n                    {/* Password Field */}\n                    <div className=\"form-group\">\n                        <label>Password:</label>\n                        <input\n                            type=\"password\"\n                            name=\"password\"\n                            value={formData.password}\n                            onChange={handleInputChange}\n                            className={errors.password || duplicateWarnings.password ? 'error' : ''}\n                            required\n                        />\n                        {errors.password && (\n                            <span className=\"error-message\">{errors.password[0]}</span>\n                        )}\n                        {duplicateWarnings.password && (\n                            <span className=\"warning-message\">{duplicateWarnings.password}</span>\n                        )}\n                    </div>\n                    \n                    {/* Confirm Password Field */}\n                    <div className=\"form-group\">\n                        <label>Confirm Password:</label>\n                        <input\n                            type=\"password\"\n                            name=\"confirm_password\"\n                            value={formData.confirm_password}\n                            onChange={handleInputChange}\n                            required\n                        />\n                    </div>\n                    \n                    {/* Phone Number Field */}\n                    <div className=\"form-group\">\n                        <label>Phone Number:</label>\n                        <input\n                            type=\"tel\"\n                            name=\"phone_number\"\n                            value={formData.phone_number}\n                            onChange={handleInputChange}\n                            className={errors.phone_number || duplicateWarnings.phone_number ? 'error' : ''}\n                        />\n                        {errors.phone_number && (\n                            <span className=\"error-message\">{errors.phone_number[0]}</span>\n                        )}\n                        {duplicateWarnings.phone_number && (\n                            <span className=\"warning-message\">{duplicateWarnings.phone_number}</span>\n                        )}\n                    </div>\n                    \n                    {/* Roll Number Field */}\n                    <div className=\"form-group\">\n                        <label>Roll Number:</label>\n                        <input\n                            type=\"text\"\n                            name=\"roll_number\"\n                            value={formData.roll_number}\n                            onChange={handleInputChange}\n                            className={errors.roll_number || duplicateWarnings.roll_number ? 'error' : ''}\n                            required\n                        />\n                        {errors.roll_number && (\n                            <span className=\"error-message\">{errors.roll_number[0]}</span>\n                        )}\n                        {duplicateWarnings.roll_number && (\n                            <span className=\"warning-message\">{duplicateWarnings.roll_number}</span>\n                        )}\n                    </div>\n                    \n                    {/* Other fields (first_name, last_name, student_class, address) */}\n                    <div className=\"form-group\">\n                        <label>First Name:</label>\n                        <input\n                            type=\"text\"\n                            name=\"first_name\"\n                            value={formData.first_name}\n                            onChange={handleInputChange}\n                        />\n                    </div>\n                    \n                    <div className=\"form-group\">\n                        <label>Last Name:</label>\n                        <input\n                            type=\"text\"\n                            name=\"last_name\"\n                            value={formData.last_name}\n                            onChange={handleInputChange}\n                        />\n                    </div>\n                    \n                    <div className=\"form-group\">\n                        <label>Class:</label>\n                        <input\n                            type=\"text\"\n                            name=\"student_class\"\n                            value={formData.student_class}\n                            onChange={handleInputChange}\n                        />\n                    </div>\n                    \n                    <div className=\"form-group\">\n                        <label>Address:</label>\n                        <textarea\n                            name=\"address\"\n                            value={formData.address}\n                            onChange={handleInputChange}\n                        />\n                    </div>\n                    \n                    <button \n                        type=\"button\" \n                        onClick={validateStep1}\n                        disabled={isValidating || Object.keys(duplicateWarnings).length > 0}\n                        className=\"next-button\"\n                    >\n                        {isValidating ? 'Validating...' : 'Next: Face Registration'}\n                    </button>\n                </div>\n            )}\n            \n            {currentStep === 2 && (\n                <div className=\"step2-form\">\n                    <h2>Step 2: Face Registration</h2>\n                    \n                    <div className=\"form-group\">\n                        <label>Capture Your Face:</label>\n                        <WebcamCapture onCapture={handleFaceCapture} />\n                    </div>\n                    \n                    <div className=\"form-actions\">\n                        <button \n                            type=\"button\" \n                            onClick={() => setCurrentStep(1)}\n                            className=\"back-button\"\n                        >\n                            Back to Step 1\n                        </button>\n                        \n                        <button \n                            type=\"button\" \n                            onClick={completeRegistration}\n                            disabled={!formData.face_image_data}\n                            className=\"complete-button\"\n                        >\n                            Complete Registration\n                        </button>\n                    </div>\n                </div>\n            )}\n        </div>\n    );\n};\n\nexport default TwoStepRegistrationForm;\n```\n\n### **CSS for Step Validation**\n\n```css\n.registration-container {\n    max-width: 600px;\n    margin: 0 auto;\n    padding: 20px;\n}\n\n.step-indicator {\n    display: flex;\n    justify-content: center;\n    margin-bottom: 30px;\n}\n\n.step {\n    padding: 10px 20px;\n    margin: 0 10px;\n    border: 2px solid #ddd;\n    border-radius: 5px;\n    background-color: #f9f9f9;\n}\n\n.step.active {\n    border-color: #007bff;\n    background-color: #e7f3ff;\n    font-weight: bold;\n}\n\n.form-group {\n    margin-bottom: 1rem;\n}\n\n.form-group label {\n    display: block;\n    margin-bottom: 0.5rem;\n    font-weight: bold;\n}\n\n.form-group input,\n.form-group textarea {\n    width: 100%;\n    padding: 0.75rem;\n    border: 1px solid #ddd;\n    border-radius: 4px;\n    font-size: 1rem;\n}\n\n.form-group input.error,\n.form-group textarea.error {\n    border: 2px solid #ff4444;\n    background-color: #fff5f5;\n}\n\n.error-message {\n    color: #ff4444;\n    font-size: 0.875rem;\n    display: block;\n    margin-top: 0.25rem;\n    font-weight: bold;\n}\n\n.warning-message {\n    color: #ff6600;\n    font-size: 0.875rem;\n    display: block;\n    margin-top: 0.25rem;\n    font-weight: bold;\n}\n\n.error-message::before,\n.warning-message::before {\n    content: \"⚠️ \";\n}\n\n.next-button,\n.complete-button,\n.back-button {\n    padding: 12px 24px;\n    font-size: 1rem;\n    border: none;\n    border-radius: 4px;\n    cursor: pointer;\n    margin: 10px 5px;\n}\n\n.next-button {\n    background-color: #007bff;\n    color: white;\n}\n\n.complete-button {\n    background-color: #28a745;\n    color: white;\n}\n\n.back-button {\n    background-color: #6c757d;\n    color: white;\n}\n\nbutton:disabled {\n    background-color: #cccccc;\n    cursor: not-allowed;\n}\n\n.form-actions {\n    display: flex;\n    justify-content: space-between;\n    margin-top: 20px;\n}\n```\n\n## 🧪 **Testing the Implementation**\n\n### **Step 1: Backend Testing**\n\n```bash\ncd backend\n\n# Run Step 1 validation tests\npython test_step1_validation.py\n\n# Expected output:\n# ✅ Username duplicate validation working\n# ✅ Step 1 validation API working\n# ✅ Individual duplicate check APIs working\n# ✅ Frontend integration scenario tested\n```\n\n### **Step 2: Frontend Testing**\n\n1. **Fill Step 1 form with existing credentials**\n2. **Click \"Next: Face Registration\" button**\n3. **Should see alerts**:\n   - \"Username already taken.\"\n   - \"Email is already taken.\"\n   - \"Mobile number is already registered.\"\n   - \"Password is already taken.\"\n   - \"Roll number already exists\"\n4. **Should NOT proceed to Step 2**\n5. **Fix duplicates and try again**\n6. **Should proceed to Step 2 when all credentials are unique**\n\n## 🎯 **Key Features**\n\n### ✅ **Real-time Validation**\n- Checks duplicates as user types (debounced)\n- Shows warnings immediately\n- Visual indicators for duplicate fields\n\n### ✅ **Step 1 Validation**\n- Validates all credentials before proceeding\n- Shows specific alerts for each duplicate\n- Prevents proceeding to face registration\n\n### ✅ **User Experience**\n- Clear step indicator\n- Immediate feedback\n- Specific error messages\n- Prevents form submission with duplicates\n\n### ✅ **Alert Messages**\n- \"Username already taken.\"\n- \"Email is already taken.\"\n- \"Mobile number is already registered.\"\n- \"Password is already taken.\"\n- \"Roll number already exists\"\n- \"This face is already registered with another account.\" (Step 2)\n\n## 🔧 **Implementation Checklist**\n\n- [ ] Add username field to registration form\n- [ ] Implement real-time duplicate checking for all fields\n- [ ] Add Step 1 validation on \"Next Face Registration\" click\n- [ ] Show specific alerts for each duplicate error\n- [ ] Prevent proceeding to Step 2 if validation fails\n- [ ] Test with existing and new credentials\n- [ ] Verify all alert messages are correct\n\nThis implementation ensures that users get immediate feedback about duplicate credentials at Step 1, preventing them from proceeding to face registration until all duplicates are resolved."
  }
]